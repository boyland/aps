name: CI

on:
  pull_request:
    branches:
      - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential flex bison gcc g++ make
        
    - name: Install Scala
      run: |
        wget -q https://downloads.lightbend.com/scala/2.12.13/scala-2.12.13.tgz
        tar xzf scala-2.12.13.tgz
        echo "$PWD/scala-2.12.13/bin" >> $GITHUB_PATH

    - name: Build project
      run: make
      
    - name: Run utilities tests
      run: |
        cd utilities/tests
        make all
      continue-on-error: false
      
    - name: Run Scala base tests
      run: |
        cd base/scala
        make test || echo "Base Scala tests completed with status $?"
      continue-on-error: true
      
    - name: Run examples Scala tests
      run: |
        cd examples/scala/tests
        make all || echo "Example Scala tests completed with status $?"
      continue-on-error: true
      
    - name: Clean up
      if: always()
      run: make clean
